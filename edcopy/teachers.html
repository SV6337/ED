<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EDVANTAGE - Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="manifest" href="manifest.json">
    
   <style>
  :root {
    /* Light Mode Colors - EXACTLY like admin_dashboard */
    --primary: #008080;
    --primary-light: #83c5be;
    --primary-dark: #004e5a;
    --secondary: #3a506b;
    --accent: #ff9e7d;
    --light: #f8f9fa;
    --dark: #2b2d42;
    --gray: #e9ecef;
    --success: #4caf50;
    --warning: #ff9800;
    --danger: #f44336;
    --card-bg: #ffffff;
    --text-primary: #2b2d42;
    --text-secondary: #4a4e69;
    --border-color: rgba(0, 0, 0, 0.08);
    --card-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
    --sidebar-bg: linear-gradient(180deg, var(--primary-dark), var(--primary));
    
    /* Dark Mode Colors - EXACTLY like admin_dashboard */
    --dark-primary: #008080;
    --dark-primary-light: #006d77;
    --dark-primary-dark: #004e5a;
    --dark-secondary: #b8c2cc;
    --dark-accent: #ff9e7d;
    --dark-light: #121212;
    --dark-dark: #e0e0e0;
    --dark-gray: #1e1e1e;
    --dark-card-bg: #1e1e1e;
    --dark-text-primary: #e0e0e0;
    --dark-text-secondary: #b8c2cc;
    --dark-border-color: rgba(255, 255, 255, 0.08);
    --dark-card-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    --dark-sidebar-bg: linear-gradient(180deg, #004e5a, #002a33);
    
    /* Shared Variables */
    --sidebar-width: 280px;
    --border-radius: 12px;
    --transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
  }

  body {
    font-family: 'Poppins', sans-serif;
    margin: 0;
    padding: 0;
    background-color: var(--light);
    color: var(--text-primary);
    line-height: 1.6;
    transition: background-color 0.3s ease, color 0.3s ease;
  }
  
  body.dark {
    --primary: var(--dark-primary);
    --primary-light: var(--dark-primary-light);
    --primary-dark: var(--dark-primary-dark);
    --secondary: var(--dark-secondary);
    --accent: var(--dark-accent);
    --light: var(--dark-light);
    --dark: var(--dark-dark);
    --gray: var(--dark-gray);
    --card-bg: var(--dark-card-bg);
    --text-primary: var(--dark-text-primary);
    --text-secondary: var(--dark-text-secondary);
    --border-color: var(--dark-border-color);
    --card-shadow: var(--dark-card-shadow);
    --sidebar-bg: var(--dark-sidebar-bg);
  }

  /* Theme Toggle Switch - EXACTLY like admin_dashboard */
  .theme-toggle {
    position: fixed;
    bottom: 25px;
    right: 25px;
    z-index: 1000;
  }
  
  .toggle-container {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 50px;
    height: 50px;
    background: var(--card-bg);
    border-radius: 50%;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    cursor: pointer;
    transition: all 0.3s ease;
    border: 2px solid var(--border-color);
  }
  
  .toggle-container:hover {
    transform: scale(1.1);
    box-shadow: 0 6px 16px rgba(0, 0, 0, 0.2);
  }
  
  .toggle-icon {
    font-size: 1.4rem;
    color: var(--primary);
    transition: all 0.3s ease;
  }
  
  body.dark .toggle-icon {
    color: var(--accent);
  }

  /* Container */
  .container {
    display: flex;
    min-height: 100vh;
  }

  /* Sidebar - Updated to match admin_dashboard */
  .sidebar {
    width: var(--sidebar-width);
    background: var(--sidebar-bg);
    color: white;
    padding: 20px 0;
    box-shadow: 2px 0 15px rgba(0,0,0,0.1);
    transition: var(--transition);
    position: fixed;
    height: 100vh;
    z-index: 100;
    left: -280px;
    top: 0;
  }
  
  .sidebar.active {
    left: 0;
  }
  
  .sidebar-header {
    padding: 0 20px 20px;
    border-bottom: 1px solid rgba(255,255,255,0.15);
    margin-bottom: 20px;
  }
  
  .sidebar-header h2 {
    margin: 0;
    font-size: 1.5rem;
    font-weight: 600;
    color: white;
    display: flex;
    align-items: center;
    gap: 10px;
  }
  
  .sidebar-nav {
    list-style: none;
    padding: 0;
    margin: 0;
  }
  
  .sidebar-nav li a {
    display: flex;
    align-items: center;
    color: white;
    text-decoration: none;
    padding: 14px 25px;
    transition: var(--transition);
    border-left: 4px solid transparent;
    font-size: 0.95rem;
    margin: 4px 0;
  }
  
  .sidebar-nav li a:hover,
  .sidebar-nav li a.active {
    background-color: rgba(255,255,255,0.1);
    border-left: 4px solid var(--accent);
  }
  
  .sidebar-nav li a i {
    margin-right: 12px;
    width: 20px;
    text-align: center;
    font-size: 1.1rem;
    color: rgba(255,255,255,0.8);
  }

  /* Hamburger Menu - Matching admin_dashboard */
  .hamburger {
    display: flex !important;
    position: fixed !important;
    top: 16px !important;
    left: 16px !important;
    width: 44px !important;
    height: 44px !important;
    border-radius: 10px;
    background: var(--card-bg);
    border: none;
    z-index: 1200 !important;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    box-shadow: 0 6px 16px rgba(0,0,0,0.2);
    flex-direction: column;
    gap: 5px;
  }

  .hamburger span {
    display: block;
    width: 22px;
    height: 2px;
    background: var(--text-primary);
    border-radius: 2px;
    transition: 0.3s ease;
  }

  /* Active = X */
  .hamburger.active span:nth-child(1) {
    transform: translateY(7px) rotate(45deg);
  }

  .hamburger.active span:nth-child(2) {
    opacity: 0;
  }

  .hamburger.active span:nth-child(3) {
    transform: translateY(-7px) rotate(-45deg);
  }

  /* Main Content - Updated */
  .main-content {
    flex: 1;
    padding: 30px;
    background-color: var(--light);
    min-height: 100vh;
    transition: background-color 0.3s ease, margin-left 0.25s ease;
    padding-left: 85px; /* Space for hamburger */
  }

  .sidebar.active ~ .main-content {
    margin-left: var(--sidebar-width);
  }

  /* Header */
  .header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 30px;
    padding-bottom: 20px;
    border-bottom: 1px solid var(--border-color);
  }

  .header h1 {
    margin: 0;
    font-size: 1.8rem;
    color: var(--primary);
    font-weight: 600;
  }

  /* Button Styles - Matching admin_dashboard */
  .btn {
    padding: 12px 24px;
    border: none;
    border-radius: var(--border-radius);
    cursor: pointer;
    font-family: 'Poppins', sans-serif;
    font-weight: 500;
    transition: var(--transition);
    display: inline-flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    min-height: 44px;
  }

  .btn i {
    margin-right: 8px;
  }

  .btn-primary {
    background-color: var(--primary);
    color: white;
  }

  .btn-primary:hover {
    background-color: var(--primary-dark);
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
  }

  .btn-secondary {
    background-color: var(--secondary);
    color: white;
  }

  .btn-secondary:hover {
    background-color: #2c3a4d;
    transform: translateY(-2px);
  }

  .btn-danger {
    background-color: var(--danger);
    color: white;
  }

  .btn-danger:hover {
    background-color: #e53935;
    transform: translateY(-2px);
  }

  /* Card Styles - Matching admin_dashboard */
  .card {
    background-color: var(--card-bg);
    border-radius: var(--border-radius);
    padding: 28px 30px;
    margin-bottom: 30px;
    box-shadow: var(--card-shadow);
    transition: var(--transition);
    border: none;
  }

  .card:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 24px rgba(0,0,0,0.12);
  }

  .card h3 {
    margin-top: 0;
    color: var(--primary);
    font-size: 1.4rem;
    font-weight: 600;
    padding-bottom: 15px;
    border-bottom: 1px solid var(--border-color);
    display: flex;
    align-items: center;
    gap: 10px;
  }

  /* Stat Cards */
  .stat-card {
    background: var(--card-bg);
    padding: 25px;
    border-radius: var(--border-radius);
    box-shadow: var(--card-shadow);
    margin-bottom: 20px;
    transition: var(--transition);
    border: none;
  }

  .stat-card:hover {
    transform: translateY(-3px);
    box-shadow: 0 8px 24px rgba(0,0,0,0.12);
  }

  .stats-container {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
  }

  /* Chart Cards */
  .chart-card {
    background: var(--card-bg);
    padding: 25px;
    border-radius: var(--border-radius);
    box-shadow: var(--card-shadow);
    margin-bottom: 20px;
    transition: var(--transition);
  }

  .chart-container {
    width: 100%;
    min-height: 220px;
    max-height: 260px;
  }

  .chart-container canvas {
    max-height: 240px;
  }

  /* Form Elements - Matching admin_dashboard */
  .form-group {
    margin-bottom: 20px;
  }

  .form-group label {
    display: block;
    margin-bottom: 8px;
    font-weight: 500;
    color: var(--text-primary);
  }

  .form-control {
    width: 100%;
    padding: 12px 15px;
    border: 1px solid var(--border-color);
    border-radius: 8px;
    font-family: 'Poppins', sans-serif;
    transition: var(--transition);
    background-color: var(--card-bg);
    color: var(--text-primary);
  }

  .form-control:focus {
    border-color: var(--primary);
    outline: none;
    box-shadow: 0 0 0 3px rgba(0, 109, 119, 0.1);
  }

  select.form-control {
    cursor: pointer;
  }

  /* Teacher Details Card - Enhanced */
  #my-details {
    background: linear-gradient(135deg, var(--card-bg) 0%, rgba(0, 128, 128, 0.05) 100%) !important;
    border-left: 5px solid var(--primary) !important;
    padding: 30px !important;
    margin-top: 30px !important;
    border-radius: 12px !important;
    box-shadow: 0 6px 20px rgba(0, 128, 128, 0.1) !important;
  }

  #my-details h2 {
    margin: 0 0 25px 0 !important;
    font-size: 1.5rem !important;
    color: var(--primary) !important;
    border-bottom: 2px solid var(--primary) !important;
    padding-bottom: 12px !important;
  }

  #my-details div {
    display: flex !important;
    justify-content: space-between !important;
    align-items: center !important;
    padding: 15px 0 !important;
    border-bottom: 1px solid var(--border-color) !important;
    font-size: 15px !important;
  }

  #my-details div:last-child {
    border-bottom: none !important;
  }

  #my-details strong {
    color: var(--primary) !important;
    font-weight: 600 !important;
    min-width: 120px !important;
  }

  #my-details span {
    color: var(--text-primary) !important;
    font-weight: 500 !important;
    text-align: right !important;
  }

  /* Logout Button - Matching admin_dashboard */
  .logout-btn {
    background-color: var(--primary);
    color: white;
    border: none;
    padding: 10px 20px;
    border-radius: var(--border-radius);
    cursor: pointer;
    font-family: 'Poppins', sans-serif;
    font-weight: 500;
    transition: var(--transition);
    display: flex;
    align-items: center;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    position: fixed;
    top: 16px;
    right: 16px;
    z-index: 1100;
  }

  .logout-btn:hover {
    background-color: var(--primary-dark);
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
  }

  .logout-btn i {
    margin-right: 8px;
  }

  /* Section Management */
  .section {
    display: none;
  }

  .section.active {
    display: block;
    animation: fadeIn 0.3s;
  }

  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
  }

  /* Loading Spinner - Matching admin_dashboard */
  .loading {
    border: 4px solid rgba(0, 0, 0, 0.1);
    border-radius: 50%;
    border-top: 4px solid var(--primary);
    width: 30px;
    height: 30px;
    animation: spin 1s linear infinite;
    margin: 0 auto;
  }

  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }

  /* Table Styles - Matching admin_dashboard */
  table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 20px;
    background-color: var(--card-bg);
    border-radius: var(--border-radius);
    overflow: hidden;
    box-shadow: var(--card-shadow);
  }

  th, td {
    padding: 14px 16px;
    text-align: left;
    border-bottom: 1px solid var(--border-color);
    color: var(--text-primary);
  }

  th {
    background: linear-gradient(to right, var(--primary), var(--primary-dark));
    color: white;
    font-weight: 500;
  }

  tr:hover td {
    background-color: rgba(131, 197, 190, 0.1);
  }

  /* Responsive Styles - Matching admin_dashboard patterns */
  @media (max-width: 768px) {
    .sidebar {
      width: 260px;
      transform: translateX(-100%);
    }

    .sidebar.active {
      transform: translateX(0);
    }

    .main-content {
      padding: 20px;
      padding-left: 70px;
      margin-left: 0 !important;
      width: 100%;
    }

    .hamburger {
      top: 14px;
      left: 14px;
    }

    .header {
      flex-direction: column;
      align-items: flex-start;
      gap: 10px;
    }

    .header h1 {
      font-size: 1.3rem;
    }

    .logout-btn {
      padding: 8px 16px;
      font-size: 14px;
      position: relative;
      top: 0;
      right: 0;
      align-self: flex-start;
    }

    .stats-container {
      grid-template-columns: 1fr;
      gap: 16px;
    }

    .stat-card, .chart-card, .card {
      padding: 15px;
      margin-bottom: 20px;
    }

    .stat-card h3, .chart-card h3, .card h3 {
      font-size: 1.1rem;
    }

    .chart-container {
      min-height: 200px;
    }

    /* Prevent body scroll when menu open */
    body.menu-open {
      overflow: hidden;
    }
  }

  @media (max-width: 480px) {
    .header h1 {
      font-size: 1.1rem;
    }

    .toggle-container {
      width: 40px;
      height: 40px;
    }

    .toggle-icon {
      font-size: 1.2rem;
    }

    .logout-btn {
      padding: 6px 12px;
      font-size: 13px;
    }
  }

  /* Mobile App Bar Styling */
  @media (max-width: 768px) {
    .header {
      position: sticky;
      top: 0;
      z-index: 100;
      background: var(--light);
      padding: 10px 12px 10px 56px;
      border-bottom: 1px solid var(--border-color);
      display: flex;
      flex-direction: column;
      gap: 2px;
      margin-bottom: 20px;
    }

    .header h1 {
      font-size: 1rem;
      font-weight: 600;
      line-height: 1.2;
    }

    /* Make logout compact icon-style */
    .logout-btn {
      position: absolute;
      right: 12px;
      top: 10px;
      padding: 6px 10px;
      font-size: 0.7rem;
      border-radius: 999px;
    }
  }

  /* Touch feedback - Matching admin_dashboard */
  .sidebar a:active {
    transform: scale(0.98);
  }

  .btn:active {
    transform: scale(0.97);
  }
</style>

</head>
<body>
  
  <!-- Theme Toggle -->
  <div class="theme-toggle">
    <div class="toggle-container" onclick="toggleTheme()">
      <i class="fas fa-adjust toggle-icon"></i>
    </div>
  </div>

  <!-- Logout Button -->
  <button class="logout-btn" onclick="logout()"><i class="fas fa-sign-out-alt"></i> Logout</button>

  <!-- Sidebar -->
  <div class="sidebar" id="sidebar">
    <div class="sidebar-header">
      <h2><i class="fas fa-graduation-cap"></i><span> EDVANTAGE</span></h2>
    </div>
    <ul class="sidebar-nav">
      <li><a href="index.html"><i class="fas fa-home"></i><span> Dashboard</span></a></li>
      <li><a href="resources.html"><i class="fas fa-folder"></i><span> Resources Upload</span></a></li>
      <li><a href="attendance.html"><i class="fas fa-check-circle"></i><span> Attendance Update</span></a></li>
      <li><a href="messages.html"><i class="fas fa-envelope"></i><span> Messages</span></a></li>
      <li><a href="performance.html"><i class="fas fa-chart-bar"></i><span> Student Performance</span></a></li>
      <li><a href="#" onclick="showSection('interview-performance')"><i class="fas fa-brain"></i><span> Interview Performance</span></a></li>
      <li><a href="events.html"><i class="fas fa-calendar-alt"></i><span> Event Notifications</span></a></li>
      <li><a href="leave-approval.html"><i class="fas fa-file-signature"></i><span> Leave Approval</span></a></li>
      <li><a href="daily-planner.html"><i class="fas fa-clipboard-list"></i><span> Daily Planner</span></a></li>
    </ul>
  </div>

  <!-- Hamburger Menu -->
  <button class="hamburger" id="hamburgerBtn" onclick="toggleSidebar()" aria-label="Toggle menu">
    <span></span>
    <span></span>
    <span></span>
  </button>

  <!-- Main Content -->
  <div class="main-content">
    <div class="header">
      <h1>Welcome, <span id="teacher-name">Loading...</span>!</h1>
      <p>Select an option from the sidebar to proceed.</p>
    </div>
    
    <div id="dashboard" class="section active">
      <div class="stats-container">
        <div class="stat-card">üìö Total Courses: <span id="total-courses">0</span></div>
        <div class="stat-card">üë®‚Äçüéì Total Students: <span id="total-students">0</span></div>
        <div class="stat-card">üìÜ Upcoming Events: <span id="upcoming-events">0</span></div>
        <div class="stat-card">üìå Pending Leaves: <span id="pending-leaves">0</span></div>
      </div>

      <!-- Loading Indicator -->
      <div id="loading" class="loading" style="display: none;"></div>

      <!-- Teacher Details Card -->
      <div class="card" id="my-details">
        <h2><i class="fas fa-user-circle"></i> Teacher Details</h2>
        <div><strong>Teacher ID:</strong> <span id="detail-teacherId">-</span></div>
        <div><strong>Name:</strong> <span id="detail-name">-</span></div>
        <div><strong>Email:</strong> <span id="detail-email">-</span></div>
        <div><strong>Phone:</strong> <span id="detail-phone">-</span></div>
      </div>
    </div>

    <div id="interview-performance" class="section">
      <div class="card">
        <h1><i class="fas fa-brain"></i> HireED Performance</h1>
        <p class="section-hint">View HireED performance (excluding Resume Builder) for your students only.</p>

        <div class="form-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 20px;">
          <div class="form-group">
            <label for="feature-filter"><strong>Feature Filter</strong></label>
            <select id="feature-filter" class="form-control">
              <option value="">All Features</option>
              <option value="interview">Interview</option>
              <option value="dsa">DSA</option>
              <option value="aptitude">Aptitude</option>
            </select>
          </div>

          <div class="form-group">
            <label for="student-filter"><strong>Student Filter</strong></label>
            <select id="student-filter" class="form-control">
              <option value="">All Students</option>
            </select>
          </div>

          <div class="form-group" id="topn-card" style="display:none;">
            <label for="topn-filter"><strong>Compare Top Students</strong></label>
            <select id="topn-filter" class="form-control">
              <option value="2">Top 2</option>
              <option value="4">Top 4</option>
              <option value="6">Top 6</option>
              <option value="0">All</option>
            </select>
          </div>
        </div>

        <div class="chart-card">
          <h3 id="chart-title-1">Average Score by Student</h3>
          <div class="chart-container">
            <canvas id="chart-1"></canvas>
          </div>
        </div>

        <div class="chart-card">
          <h3 id="chart-title-2">Attempts</h3>
          <div class="chart-container">
            <canvas id="chart-2"></canvas>
          </div>
        </div>

        <div class="chart-card">
          <h3 id="chart-title-3">Score Distribution</h3>
          <div class="chart-container">
            <canvas id="chart-3"></canvas>
          </div>
        </div>

        <div class="chart-card">
          <h3 id="chart-title-4">Performance Metrics</h3>
          <div class="chart-container">
            <canvas id="chart-4"></canvas>
          </div>
        </div>

        <div class="chart-card">
          <h3 id="chart-title-5">Latest Scores</h3>
          <div class="chart-container">
            <canvas id="chart-5"></canvas>
          </div>
        </div>

        <div class="card">
          <h3><i class="fas fa-trophy"></i> Top Performers</h3>
          <div id="topper-list">No data yet.</div>
        </div>

        <div class="card">
          <h3><i class="fas fa-history"></i> Performance History</h3>
          <table>
            <thead>
              <tr>
                <th>Student</th>
                <th>Feature</th>
                <th>Job Type</th>
                <th>Score</th>
                <th>Date</th>
              </tr>
            </thead>
            <tbody id="interview-table"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    const BASE_URL = 'http://localhost:5000';
    let chart1, chart2, chart3, chart4, chart5;

    // Theme Management - EXACTLY like admin_dashboard
    function toggleTheme() {
      const container = document.querySelector('.toggle-container');
      const icon = document.querySelector('.toggle-icon');
      
      // Add animation class
      container.classList.add('theme-changed');
      
      // Remove animation class after it completes
      setTimeout(() => {
        container.classList.remove('theme-changed');
      }, 600);
      
      // Toggle theme
      document.body.classList.toggle('dark');
      const isDark = document.body.classList.contains('dark');
      localStorage.setItem('theme', isDark ? 'dark' : 'light');
    }

    // Check saved theme preference
    window.addEventListener('DOMContentLoaded', () => {
      const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
      const savedTheme = localStorage.getItem('theme');
      
      if (savedTheme === 'dark' || (!savedTheme && prefersDark)) {
        document.body.classList.add('dark');
      }
      
      // Listen for system theme changes
      window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', e => {
        if (!localStorage.getItem('theme')) {
          document.body.classList.toggle('dark', e.matches);
        }
      });

      // Load teacher data
      fetchMyDetails();
      fetchTeacherData();
      loadInterviewPerformance();
    });

    // Sidebar toggle with hamburger animation
    function toggleSidebar() {
      const sidebar = document.getElementById('sidebar');
      const hamburger = document.getElementById('hamburgerBtn');
      const isMobile = window.innerWidth <= 768;

      if (isMobile) {
        sidebar.classList.toggle('active');
        hamburger.classList.toggle('active');
        document.body.classList.toggle('menu-open', sidebar.classList.contains('active'));
      } else {
        sidebar.classList.toggle('active');
        hamburger.classList.toggle('active');
      }
    }

    // Auto-close sidebar on mobile when clicking a link
    document.querySelectorAll('.sidebar a').forEach(link => {
      link.addEventListener('click', () => {
        const isMobile = window.innerWidth <= 768;
        if (isMobile) {
          document.getElementById('sidebar').classList.remove('active');
          document.getElementById('hamburgerBtn').classList.remove('active');
          document.body.classList.remove('menu-open');
        }
      });
    });

    // Existing functions (unchanged)
    function logout() {
      localStorage.removeItem('teacherId');
      localStorage.removeItem('teacherName');
      localStorage.removeItem('teacherCode');
      window.location.href = "index.html";
    }

    function showSection(sectionId) {
      document.querySelectorAll('.section').forEach(section => {
        section.classList.remove('active');
      });
      const target = document.getElementById(sectionId);
      if (target) {
        target.classList.add('active');
      }
    }

    async function fetchTeacherData() {
      try {
        document.getElementById("loading").style.display = "block";
        const teacherId = localStorage.getItem('teacherId');
        
        if (!teacherId) {
          window.location.href = "index.html";
          return;
        }

        const response = await fetch(`${BASE_URL}/api/dashboard/${teacherId}`);
        if (!response.ok) throw new Error('Failed to load dashboard data');
        
        const { data } = await response.json();
        
        document.getElementById("total-courses").textContent = data.totalCourses;
        document.getElementById("total-students").textContent = data.totalStudents;
        document.getElementById("upcoming-events").textContent = data.upcomingEvents;
        document.getElementById("pending-leaves").textContent = data.pendingLeaves;

      } catch (error) {
        console.error("Error:", error);
      } finally {
        document.getElementById("loading").style.display = "none";
      }
    }

    async function fetchMyDetails() {
      try {
        const mongoId = localStorage.getItem('teacherId');
        const cachedName = localStorage.getItem('teacherName');
        const code = localStorage.getItem('teacherCode');

        if (cachedName) {
          document.getElementById('teacher-name').textContent = cachedName;
          document.getElementById('detail-name').textContent = cachedName;
        }

        if (mongoId) {
          const res = await fetch(`${BASE_URL}/teachers/${mongoId}`);
          if (res.ok) {
            const t = await res.json();
            document.getElementById('teacher-name').textContent = t.name || cachedName || 'Teacher';
            document.getElementById('detail-teacherId').textContent = t.teacherId || t._id || '-';
            document.getElementById('detail-name').textContent = t.name || cachedName || '-';
            document.getElementById('detail-email').textContent = t.email || '-';
            document.getElementById('detail-phone').textContent = t.phone || '-';
            localStorage.setItem('teacherName', t.name || cachedName || '');
            return;
          }
        }

        if (code) {
          const res2 = await fetch(`${BASE_URL}/teachers/by-code/${encodeURIComponent(code)}`);
          if (res2.ok) {
            const t2 = await res2.json();
            document.getElementById('teacher-name').textContent = t2.name || cachedName || 'Teacher';
            document.getElementById('detail-teacherId').textContent = t2.teacherId || t2._id || '-';
            document.getElementById('detail-name').textContent = t2.name || cachedName || '-';
            document.getElementById('detail-email').textContent = t2.email || '-';
            document.getElementById('detail-phone').textContent = t2.phone || '-';
            localStorage.setItem('teacherName', t2.name || cachedName || '');
            return;
          }
        }

        console.warn('Teacher details could not be fetched');
      } catch (error) {
        console.error('Error fetching teacher details:', error);
      }
    }

    function destroyCharts() {
      [chart1, chart2, chart3, chart4, chart5].forEach(chart => {
        if (chart) chart.destroy();
      });
    }

    function getScoreBuckets(scores) {
      const buckets = [0, 0, 0, 0, 0, 0];
      scores.forEach(score => {
        if (score <= 1) buckets[0] += 1;
        else if (score <= 3) buckets[1] += 1;
        else if (score <= 5) buckets[2] += 1;
        else if (score <= 7) buckets[3] += 1;
        else if (score <= 9) buckets[4] += 1;
        else buckets[5] += 1;
      });
      return buckets;
    }

    async function loadInterviewPerformance() {
      try {
        const teacherId = localStorage.getItem('teacherId');
        if (!teacherId) return;

        const res = await fetch(`${BASE_URL}/interview-performance/teacher/${teacherId}`);
        const data = await res.json();
        if (!res.ok) throw new Error(data.error || 'Failed to load interview performance');

        const items = data.items || [];
        const normalizedItems = items.map(entry => {
          const rawStudentId = entry.studentId && entry.studentId._id ? entry.studentId._id : entry.studentId;
          return {
            ...entry,
            studentId: String(rawStudentId || ''),
            feature: (entry.feature || 'interview').toLowerCase()
          };
        });
        const students = data.students || [];

        const studentFilter = document.getElementById('student-filter');
        const featureFilter = document.getElementById('feature-filter');
        const topNFilter = document.getElementById('topn-filter');
        const topNCard = document.getElementById('topn-card');

        const selectedStudent = studentFilter.value;
        const selectedFeature = featureFilter.value;

        studentFilter.innerHTML = '<option value="">All Students</option>';
        students.forEach(stu => {
          const opt = document.createElement('option');
          opt.value = stu.id;
          opt.textContent = `${stu.name}${stu.studentCode ? ` (${stu.studentCode})` : ''}`;
          studentFilter.appendChild(opt);
        });

        if (selectedStudent) {
          studentFilter.value = selectedStudent;
        }
        if (selectedFeature) {
          featureFilter.value = selectedFeature;
        }
        const filtered = normalizedItems.filter(it => {
          const matchesStudent = selectedStudent ? it.studentId === selectedStudent : true;
          const matchesFeature = selectedFeature ? it.feature === selectedFeature : true;
          return matchesStudent && matchesFeature;
        });
        destroyCharts();

        const topperList = document.getElementById('topper-list');
        const chartTitle1 = document.getElementById('chart-title-1');
        const chartTitle2 = document.getElementById('chart-title-2');
        const chartTitle3 = document.getElementById('chart-title-3');
        const chartTitle4 = document.getElementById('chart-title-4');
        const chartTitle5 = document.getElementById('chart-title-5');

        if (selectedStudent) {
          topNCard.style.display = 'none';
          const studentData = filtered.filter(entry => String(entry.studentId) === selectedStudent);
          const scores = studentData.map(entry => Number(entry.score || 0));
          const labels = studentData.map(entry => new Date(entry.createdAt).toLocaleDateString());

          chartTitle1.textContent = 'Scores Over Time';
          chart1 = new Chart(document.getElementById('chart-1').getContext('2d'), {
            type: 'line',
            data: {
              labels,
              datasets: [{
                label: 'Score',
                data: scores,
                borderColor: 'rgba(0, 128, 128, 1)',
                backgroundColor: 'rgba(0, 128, 128, 0.2)',
                tension: 0.3,
                fill: true
              }]
            },
            options: { responsive: true, scales: { y: { beginAtZero: true, max: 10 } } }
          });

          chartTitle2.textContent = 'Attempt Scores';
          chart2 = new Chart(document.getElementById('chart-2').getContext('2d'), {
            type: 'bar',
            data: {
              labels: scores.map((_, i) => `Attempt ${i + 1}`),
              datasets: [{
                label: 'Score',
                data: scores,
                backgroundColor: 'rgba(255, 158, 125, 0.6)'
              }]
            },
            options: { responsive: true, scales: { y: { beginAtZero: true, max: 10 } } }
          });

          chartTitle3.textContent = 'Score Distribution';
          chart3 = new Chart(document.getElementById('chart-3').getContext('2d'), {
            type: 'bar',
            data: {
              labels: ['0-1', '2-3', '4-5', '6-7', '8-9', '10'],
              datasets: [{
                label: 'Count',
                data: getScoreBuckets(scores),
                backgroundColor: 'rgba(63, 55, 201, 0.6)'
              }]
            },
            options: { responsive: true, scales: { y: { beginAtZero: true } } }
          });

          const attemptsCount = scores.length;
          const avgScore = attemptsCount ? (scores.reduce((a, b) => a + b, 0) / attemptsCount) : 0;
          const passRate = attemptsCount ? Math.round((scores.filter(s => s >= 6).length / attemptsCount) * 100) : 0;
          const maxScore = scores.length ? Math.max(...scores) : 0;
          const minScore = scores.length ? Math.min(...scores) : 0;

          chartTitle4.textContent = 'Performance Metrics';
          chart4 = new Chart(document.getElementById('chart-4').getContext('2d'), {
            type: 'radar',
            data: {
              labels: ['Average', 'Max', 'Min', 'Attempts', 'Pass Rate'],
              datasets: [{
                label: 'Metrics',
                data: [avgScore, maxScore, minScore, attemptsCount, passRate / 10],
                backgroundColor: 'rgba(0, 128, 128, 0.2)',
                borderColor: 'rgba(0, 128, 128, 1)'
              }]
            },
            options: { responsive: true, scales: { r: { beginAtZero: true, max: 10 } } }
          });

          chartTitle5.textContent = 'Pass vs Fail';
          chart5 = new Chart(document.getElementById('chart-5').getContext('2d'), {
            type: 'doughnut',
            data: {
              labels: ['Pass', 'Fail'],
              datasets: [{
                data: [scores.filter(s => s >= 6).length, scores.filter(s => s < 6).length],
                backgroundColor: ['rgba(76, 175, 80, 0.7)', 'rgba(244, 67, 54, 0.7)']
              }]
            },
            options: { responsive: true }
          });

          topperList.textContent = studentData.length ? 'Viewing selected student.' : 'No data for selected student.';
        } else {
          topNCard.style.display = 'block';
          const summaryMap = new Map();
          filtered.forEach(entry => {
            const id = entry.studentId;
            if (!summaryMap.has(id)) {
              summaryMap.set(id, { total: 0, count: 0, name: entry.studentName || 'Student', latestScore: Number(entry.score || 0) });
            }
            const row = summaryMap.get(id);
            row.total += Number(entry.score || 0);
            row.count += 1;
            row.latestScore = Number(entry.score || 0);
          });

          const summaryArray = Array.from(summaryMap.values()).map(item => ({
            name: item.name,
            avg: item.count ? (item.total / item.count) : 0,
            attempts: item.count,
            latestScore: item.latestScore
          })).sort((a, b) => b.avg - a.avg);

          const topN = Number(topNFilter.value || 0);
          const compareList = topN && topN > 0 ? summaryArray.slice(0, topN) : summaryArray;

          const labels = compareList.map(item => item.name);
          const avgScores = compareList.map(item => item.avg.toFixed(2));
          const attempts = compareList.map(item => item.attempts);
          const latestScores = compareList.map(item => item.latestScore);

          chartTitle1.textContent = 'Average Score by Student';
          chart1 = new Chart(document.getElementById('chart-1').getContext('2d'), {
            type: 'bar',
            data: {
              labels,
              datasets: [{
                label: 'Average Score',
                data: avgScores,
                backgroundColor: 'rgba(0, 128, 128, 0.6)'
              }]
            },
            options: { responsive: true, scales: { y: { beginAtZero: true, max: 10 } } }
          });

          chartTitle2.textContent = 'Attempts by Student';
          chart2 = new Chart(document.getElementById('chart-2').getContext('2d'), {
            type: 'line',
            data: {
              labels,
              datasets: [{
                label: 'Attempts',
                data: attempts,
                borderColor: 'rgba(255, 158, 125, 1)',
                backgroundColor: 'rgba(255, 158, 125, 0.2)',
                tension: 0.3,
                fill: true
              }]
            },
            options: { responsive: true, scales: { y: { beginAtZero: true } } }
          });

          chartTitle3.textContent = 'Average Score Distribution';
          chart3 = new Chart(document.getElementById('chart-3').getContext('2d'), {
            type: 'bar',
            data: {
              labels: ['0-1', '2-3', '4-5', '6-7', '8-9', '10'],
              datasets: [{
                label: 'Students',
                data: getScoreBuckets(compareList.map(item => item.avg)),
                backgroundColor: 'rgba(63, 55, 201, 0.6)'
              }]
            },
            options: { responsive: true, scales: { y: { beginAtZero: true } } }
          });

          chartTitle4.textContent = 'Average vs Latest Score';
          chart4 = new Chart(document.getElementById('chart-4').getContext('2d'), {
            type: 'radar',
            data: {
              labels,
              datasets: [
                {
                  label: 'Average',
                  data: avgScores,
                  backgroundColor: 'rgba(0, 128, 128, 0.2)',
                  borderColor: 'rgba(0, 128, 128, 1)'
                },
                {
                  label: 'Latest',
                  data: latestScores,
                  backgroundColor: 'rgba(255, 158, 125, 0.2)',
                  borderColor: 'rgba(255, 158, 125, 1)'
                }
              ]
            },
            options: { responsive: true, scales: { r: { beginAtZero: true, max: 10 } } }
          });

          chartTitle5.textContent = 'Latest Scores by Student';
          chart5 = new Chart(document.getElementById('chart-5').getContext('2d'), {
            type: 'bar',
            data: {
              labels,
              datasets: [{
                label: 'Latest Score',
                data: latestScores,
                backgroundColor: 'rgba(76, 175, 80, 0.6)'
              }]
            },
            options: { responsive: true, scales: { y: { beginAtZero: true, max: 10 } } }
          });

          const topperHtml = summaryArray.slice(0, 3).map((item, idx) => {
            return `<div><strong>#${idx + 1}</strong> ${item.name} ‚Äî Avg ${item.avg.toFixed(2)}</div>`;
          }).join('');
          topperList.innerHTML = topperHtml || 'No data yet.';
        }

        const tableBody = document.getElementById('interview-table');
        tableBody.innerHTML = '';
        filtered.slice(0, 100).forEach(entry => {
          const tr = document.createElement('tr');
          const date = entry.createdAt ? new Date(entry.createdAt).toLocaleString() : '';
          tr.innerHTML = `
            <td>${entry.studentName || '-'}</td>
            <td>${entry.feature || '-'}</td>
            <td>${entry.jobType || '-'}</td>
            <td>${entry.score ?? '-'}</td>
            <td>${date}</td>
          `;
          tableBody.appendChild(tr);
        });
      } catch (error) {
        console.error('Interview performance error:', error);
      }
    }

    // Event listeners for filters
    document.getElementById('student-filter').addEventListener('change', loadInterviewPerformance);
    document.getElementById('feature-filter').addEventListener('change', loadInterviewPerformance);
    document.getElementById('topn-filter').addEventListener('change', loadInterviewPerformance);

    // Service Worker
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('service-worker.js');
    }
  </script>
</body>
</html>